<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>ë¡œë˜ 6/45 - ë°ì´í„° ê´€ë¦¬</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .bonus-label {
      font-size:11px; color:#888; text-align:center; margin-top:4px;
    }
    .num-inputs-7 {
      display:grid; grid-template-columns:repeat(4,1fr); gap:8px; margin-bottom:10px;
    }
    .num-inputs-bonus {
      display:grid; grid-template-columns:1fr; gap:8px; margin-bottom:10px;
    }
    .num-btn-bonus {
      padding:14px 8px; border:2px dashed #ffa500; border-radius:10px;
      background:white; color:#ffa500; font-size:16px; font-weight:bold;
      cursor:pointer; transition:all 0.2s; text-align:center; width:100%;
    }
    .num-btn-bonus.filled { background:#ffa500; color:white; border-style:solid; }
    .fb-status {
      padding:10px 14px; border-radius:10px; font-size:13px;
      margin-bottom:10px; display:none;
    }
    .fb-status.ok  { background:#d4edda; color:#155724; border:1px solid #c3e6cb; }
    .fb-status.err { background:#f8d7da; color:#721c24; border:1px solid #f5c6cb; }
    .fb-status.info{ background:#d1ecf1; color:#0c5460; border:1px solid #bee5eb; }
    .draw-preview {
      display:flex; gap:6px; align-items:center; flex-wrap:wrap;
      justify-content:center; padding:10px; background:#f8f9fa;
      border-radius:10px; margin-bottom:10px; min-height:60px;
    }
    .input-section-label {
      font-size:12px; color:#888; font-weight:bold;
      margin-bottom:6px; display:block;
    }
  </style>
</head>
<body>
<div class="container">

  <div class="header">
    <h1>ğŸ° ë¡œë˜ 6/45</h1>
    <div style="font-size:12px;color:#888;margin-top:4px;">ë‹¹ì²¨ ë°ì´í„° ê´€ë¦¬</div>
    <div id="latestDraw" style="margin-top:10px;padding:10px;background:#f8f9fa;border-radius:10px;display:none;">
      <div style="font-size:11px;color:#888;margin-bottom:6px;" id="latestRoundLabel">ìµœì‹  íšŒì°¨</div>
      <div id="latestBalls" style="display:flex;gap:5px;justify-content:center;flex-wrap:wrap;"></div>
    </div>
  </div>

  <div class="content">
    <div class="section-title">ğŸ”¥ Firebase ë°ì´í„° ê´€ë¦¬</div>

    <!-- Firebase ìƒíƒœ í‘œì‹œ -->
    <div id="fbStatus" class="fb-status info">Firebase ì—°ê²° ì¤‘...</div>

    <!-- â”€â”€ ìƒˆ íšŒì°¨ ì…ë ¥ â”€â”€ -->
    <div class="analysis-section">
      <div class="analysis-title">â• ìƒˆ íšŒì°¨ ì…ë ¥</div>
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px;">
        <span style="font-size:14px;color:#666;">ë‹¤ìŒ íšŒì°¨:</span>
        <span id="nextRoundDisplay" style="font-size:22px;font-weight:bold;color:#667eea;">-</span>
        <span style="font-size:14px;color:#666;">íšŒ</span>
      </div>

      <!-- ë‹¹ì²¨ë²ˆí˜¸ 6ê°œ -->
      <span class="input-section-label">ğŸ± ë‹¹ì²¨ë²ˆí˜¸ (6ê°œ)</span>
      <div class="num-inputs" id="numInputGrid">
        <button class="num-btn" onclick="openDialog(0)">1ë²ˆ</button>
        <button class="num-btn" onclick="openDialog(1)">2ë²ˆ</button>
        <button class="num-btn" onclick="openDialog(2)">3ë²ˆ</button>
        <button class="num-btn" onclick="openDialog(3)">4ë²ˆ</button>
        <button class="num-btn" onclick="openDialog(4)">5ë²ˆ</button>
        <button class="num-btn" onclick="openDialog(5)">6ë²ˆ</button>
      </div>

      <!-- ë³´ë„ˆìŠ¤ë²ˆí˜¸ -->
      <span class="input-section-label">â­ ë³´ë„ˆìŠ¤ë²ˆí˜¸</span>
      <div class="num-inputs-bonus">
        <button class="num-btn-bonus" id="bonusBtn" onclick="openBonusDialog()">ë³´ë„ˆìŠ¤</button>
      </div>

      <!-- ë¯¸ë¦¬ë³´ê¸° -->
      <div class="draw-preview" id="drawPreview">
        <span style="color:#ccc;font-size:13px;">ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ë©´ ë¯¸ë¦¬ë³´ê¸°ê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤</span>
      </div>

      <button class="btn btn-primary" onclick="addNewDraw()">ğŸ”¥ Firebaseì— ì €ì¥</button>
    </div>

    <!-- â”€â”€ CSV ì—…ë¡œë“œ â”€â”€ -->
    <div class="analysis-section">
      <div class="analysis-title">ğŸ“ CSV ì¼ê´„ ì—…ë¡œë“œ</div>
      <div style="font-size:12px;color:#888;margin-bottom:8px;">
        í˜•ì‹(ì‹ ): íšŒì°¨,ì¶”ì²¨ì¼,ë²ˆí˜¸1~6,ë³´ë„ˆìŠ¤,ë‹¹ì²¨ê²Œì„ìˆ˜,ë‹¹ì²¨ê¸ˆì•¡ ï¿½ í˜•ì‹(êµ¬): íšŒì°¨,ë²ˆí˜¸1~6,ë³´ë„ˆìŠ¤ (ìë™ì¸ì‹)
      </div>
      <label for="csvFile" style="display:block;padding:13px;background:#8884D8;color:white;border-radius:10px;text-align:center;cursor:pointer;font-weight:bold;margin-bottom:4px;">
        ğŸ“„ ë‹¹ì²¨ë²ˆí˜¸.csv ì„ íƒ
      </label>
      <input type="file" id="csvFile" accept=".csv" style="display:none" onchange="handleFileUpload(event)">
    </div>

    <!-- ê²°ê³¼ í‘œì‹œ -->
    <div id="importSuccess" class="alert alert-success hidden"></div>

    <!-- â”€â”€ Firebase í˜„í™© â”€â”€ -->
    <div class="analysis-section">
      <div class="analysis-title">ğŸ“Š Firebase í˜„í™©</div>
      <div id="fbSummary" style="font-size:13px;color:#666;">ë¡œë”© ì¤‘...</div>
      <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap;">
        <button class="btn btn-secondary" style="flex:1;margin:0;" onclick="refreshFbSummary()">ğŸ”„ í˜„í™© ê°±ì‹ </button>
        <button class="btn btn-secondary" style="flex:1;margin:0;" onclick="downloadWinCSV()">â¬‡ï¸ CSV ë‹¤ìš´ë¡œë“œ</button>
      </div>
    </div>

    <!-- ë¡œê·¸ -->
    <div id="statusBoard" class="alert alert-info hidden">
      <div style="font-weight:bold;margin-bottom:6px;">ğŸ“‹ ë¡œê·¸</div>
      <div id="statusLog" style="font-size:12px;font-family:monospace;line-height:1.6;max-height:180px;overflow-y:auto;"></div>
    </div>

  </div>
</div>

<!-- ë²ˆí˜¸ ì„ íƒ ë‹¤ì´ì–¼ë¡œê·¸ -->
<div id="dialogOverlay" class="dialog-overlay hidden" onclick="closeDialogOutside(event)">
  <div class="dialog-box" onclick="event.stopPropagation()">
    <div class="dialog-title" id="dialogTitle">ë²ˆí˜¸ ì„ íƒ</div>
    <div class="dialog-grid" id="dialogGrid"></div>
    <div class="dialog-actions">
      <button class="d-cancel"  onclick="closeDialog()">ì·¨ì†Œ</button>
      <button class="d-confirm" onclick="confirmDialog()">í™•ì¸</button>
    </div>
  </div>
</div>

<!-- Firebase SDK (ìŠ¤í¬ë¦½íŠ¸ ìµœìƒë‹¨ ë¡œë“œ í•„ìˆ˜) -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script>
// â”€â”€ Firebase ì´ˆê¸°í™” â”€â”€
firebase.initializeApp({
    apiKey:            "AIzaSyB4S8qkK07QYXq5yw0Coo69sZBIk0uew2E",
    authDomain:        "randextraccube-engine.firebaseapp.com",
    projectId:         "randextraccube-engine",
    storageBucket:     "randextraccube-engine.firebasestorage.app",
    messagingSenderId: "515597545439",
    appId:             "1:515597545439:web:f1e804554406719a3cde6a"
});
var db = firebase.firestore();
window._lottoDB = db;

var FB_COLLECTION  = 'lotto_history';
var FB_HISTORY_DOC = 'lotto645_history';
var LS_KEY         = 'lotto645_v2';

var lottoData   = [];
var inputNums   = [null, null, null, null, null, null];
var bonusNum    = null;
var dialogSlot  = -1;
var dialogMode  = 'normal'; // 'normal' | 'bonus'
var dialogTempVal = null;

// â”€â”€ ê³µ ìƒ‰ìƒ í´ë˜ìŠ¤ â”€â”€
function ballClass(n) {
    if (n <= 10) return 'r1';
    if (n <= 20) return 'r2';
    if (n <= 30) return 'r3';
    if (n <= 40) return 'r4';
    return 'r5';
}

// â”€â”€ ë¡œê·¸ â”€â”€
function addLog(msg, type) {
    var board = document.getElementById('statusBoard');
    var log   = document.getElementById('statusLog');
    if (!board || !log) return;
    board.classList.remove('hidden');
    var icon  = type==='success'?'âœ…':type==='error'?'âŒ':'â„¹ï¸';
    var color = type==='success'?'#155724':type==='error'?'#721c24':'#0c5460';
    var d = document.createElement('div');
    d.style.color = color;
    d.innerHTML = '[' + new Date().toLocaleTimeString('ko-KR') + '] ' + icon + ' ' + msg;
    log.appendChild(d);
    log.scrollTop = log.scrollHeight;
}

function showFbStatus(msg, type) {
    var el = document.getElementById('fbStatus');
    el.textContent = msg;
    el.className = 'fb-status ' + (type || 'info');
    el.style.display = 'block';
}

// â”€â”€ Firebaseì—ì„œ history ë¡œë“œ â”€â”€
async function loadFromFirebase() {
    try {
        var snap = await db.collection(FB_COLLECTION).doc(FB_HISTORY_DOC).get();
        if (snap.exists) {
            var data = snap.data();
            if (data && data.draws && data.draws.length > 0) {
                return data.draws;
            }
        }
        return [];
    } catch(e) {
        addLog('Firebase ë¡œë“œ ì‹¤íŒ¨: ' + e.message, 'error');
        return [];
    }
}

// â”€â”€ Firebaseì— history ì „ì²´ ì €ì¥ â”€â”€
async function saveHistoryToFirebase() {
    if (!lottoData.length) return false;
    try {
        await db.collection(FB_COLLECTION).doc(FB_HISTORY_DOC).set({
            draws    : lottoData,
            count    : lottoData.length,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        // LocalStorageë„ ë™ê¸°í™”
        localStorage.setItem(LS_KEY, JSON.stringify({
            savedAt: new Date().toISOString(),
            data   : lottoData
        }));
        return true;
    } catch(e) {
        addLog('Firebase ì €ì¥ ì‹¤íŒ¨: ' + e.message, 'error');
        return false;
    }
}

// â”€â”€ ë‹¤ìŒ íšŒì°¨ í‘œì‹œ ê°±ì‹  â”€â”€
function updateNextRoundDisplay() {
    var next = lottoData.length > 0 ? lottoData[lottoData.length-1].round + 1 : 1;
    document.getElementById('nextRoundDisplay').textContent = next;
}

// â”€â”€ ìµœì‹  íšŒì°¨ í—¤ë” í‘œì‹œ â”€â”€
function updateLatestHeader() {
    if (!lottoData.length) return;
    var last = lottoData[lottoData.length-1];
    var wrap = document.getElementById('latestDraw');
    var lbl  = document.getElementById('latestRoundLabel');
    var balls = document.getElementById('latestBalls');
    if (!wrap) return;
    wrap.style.display = 'block';
    lbl.textContent = last.round + 'íšŒì°¨';
    balls.innerHTML = '';
    last.numbers.forEach(function(n) {
        var d = document.createElement('div');
        d.className = 'mini-ball ' + ballClass(n);
        d.textContent = n;
        balls.appendChild(d);
    });
    if (last.bonus) {
        var sep = document.createElement('span');
        sep.style.cssText = 'color:#999;font-size:14px;line-height:28px;margin:0 2px;';
        sep.textContent = '+';
        balls.appendChild(sep);
        var bd = document.createElement('div');
        bd.className = 'mini-ball ' + ballClass(last.bonus);
        bd.style.boxShadow = '0 0 0 2px #ffa500';
        bd.textContent = last.bonus;
        balls.appendChild(bd);
    }
}

// â”€â”€ Firebase í˜„í™© í‘œì‹œ â”€â”€
async function refreshFbSummary() {
    var el = document.getElementById('fbSummary');
    el.textContent = 'ë¡œë”© ì¤‘...';
    try {
        var snap = await db.collection(FB_COLLECTION).doc(FB_HISTORY_DOC).get();
        if (snap.exists) {
            var data = snap.data();
            var cnt  = data.count || (data.draws ? data.draws.length : 0);
            var upd  = data.updatedAt ? data.updatedAt.toDate().toLocaleString('ko-KR') : '-';
            var first = data.draws && data.draws[0] ? data.draws[0].round : '-';
            var last  = data.draws && data.draws.length > 0 ? data.draws[data.draws.length-1].round : '-';
            el.innerHTML =
                'ì´ <strong>' + cnt + '</strong>íšŒì°¨ ì €ì¥ë¨<br>' +
                'ë²”ìœ„: <strong>' + first + '~' + last + '</strong>íšŒ<br>' +
                'ìµœê·¼ ì—…ë°ì´íŠ¸: ' + upd;
        } else {
            el.textContent = 'ì €ì¥ëœ ë°ì´í„° ì—†ìŒ';
        }
    } catch(e) {
        el.textContent = 'ì¡°íšŒ ì‹¤íŒ¨: ' + e.message;
    }
}

// â”€â”€ ë¯¸ë¦¬ë³´ê¸° ê°±ì‹  â”€â”€
function updatePreview() {
    var preview = document.getElementById('drawPreview');
    var nums = inputNums.filter(function(n){ return n !== null; });
    if (!nums.length && !bonusNum) {
        preview.innerHTML = '<span style="color:#ccc;font-size:13px;">ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ë©´ ë¯¸ë¦¬ë³´ê¸°ê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤</span>';
        return;
    }
    var html = nums.map(function(n){
        return '<div class="lotto-ball ' + ballClass(n) + '" style="width:40px;height:40px;font-size:15px;">' + n + '</div>';
    }).join('');
    if (bonusNum) {
        html += '<span style="color:#999;font-size:16px;line-height:40px;margin:0 2px;">+</span>';
        html += '<div class="lotto-ball ' + ballClass(bonusNum) + '" style="width:40px;height:40px;font-size:15px;box-shadow:0 0 0 3px #ffa500,0 3px 8px rgba(0,0,0,0.28);">' + bonusNum + '</div>';
    }
    preview.innerHTML = html;
}

// â”€â”€ ìƒˆ íšŒì°¨ ì €ì¥ â”€â”€
async function addNewDraw() {
    var round = lottoData.length > 0 ? lottoData[lottoData.length-1].round + 1 : 1;
    if (inputNums.some(function(n){ return n === null; })) {
        alert('ë‹¹ì²¨ë²ˆí˜¸ 6ê°œë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }
    if (new Set(inputNums).size !== 6) {
        alert('ì¤‘ë³µëœ ë²ˆí˜¸ê°€ ìˆìŠµë‹ˆë‹¤.');
        return;
    }
    if (bonusNum && inputNums.indexOf(bonusNum) >= 0) {
        alert('ë³´ë„ˆìŠ¤ë²ˆí˜¸ê°€ ë‹¹ì²¨ë²ˆí˜¸ì™€ ì¤‘ë³µë©ë‹ˆë‹¤.');
        return;
    }
    if (lottoData.some(function(d){ return d.round === round; })) {
        addLog(round + 'íšŒëŠ” ì´ë¯¸ ì¡´ì¬í•©ë‹ˆë‹¤.', 'error');
        return;
    }

    var nums = inputNums.slice().sort(function(a,b){ return a-b; });
    lottoData.push({ round: round, numbers: nums, bonus: bonusNum || 0 });
    lottoData.sort(function(a,b){ return a.round - b.round; });

    var btn = document.querySelector('[onclick="addNewDraw()"]');
    if (btn) { btn.disabled = true; btn.textContent = 'â³ ì €ì¥ ì¤‘...'; }

    var ok = await saveHistoryToFirebase();
    if (ok) {
        showFbStatus('âœ… ' + round + 'íšŒ Firebase ì €ì¥ ì™„ë£Œ', 'ok');
        addLog(round + 'íšŒ ì €ì¥ ì™„ë£Œ (ë³´ë„ˆìŠ¤: ' + (bonusNum || 'ì—†ìŒ') + ')', 'success');
        // ì…ë ¥ ì´ˆê¸°í™”
        inputNums = [null, null, null, null, null, null];
        bonusNum  = null;
        refreshNumBtns();
        updateNextRoundDisplay();
        updateLatestHeader();
        updatePreview();
        refreshFbSummary();
    } else {
        // ì‹¤íŒ¨ ì‹œ lottoDataì—ì„œ ì œê±°
        lottoData.pop();
        showFbStatus('âŒ Firebase ì €ì¥ ì‹¤íŒ¨', 'err');
    }

    if (btn) { btn.disabled = false; btn.textContent = 'ğŸ”¥ Firebaseì— ì €ì¥'; }
}

// â”€â”€ CSV ì—…ë¡œë“œ â”€â”€
function handleFileUpload(event) {
    var file = event.target.files[0];
    if (!file) return;
    addLog('íŒŒì¼: ' + file.name);
    var reader = new FileReader();
    reader.onload = function(e) { parseCSV(e.target.result); };
    reader.readAsText(file, 'UTF-8');
}

function parseCSV(text) {
    var lines = text.replace(/\r\n/g,'\n').replace(/\r/g,'\n').trim().split('\n');
    addLog('ì´ ' + lines.length + 'ì¤„ íŒŒì‹±');
    var parsed = [];
    var headerCols = (lines[0] || '').split(',');
    var isNewFormat = headerCols.length >= 9 && /ë‚ ì§œ|ì¶”ì²¨ì¼|date/i.test(headerCols[1]);
    var numStart = isNewFormat ? 2 : 1;
    var bonusIdx = isNewFormat ? 8 : 7;
    var dateIdx  = isNewFormat ? 1 : -1;
    addLog('CSV í˜•ì‹: ' + (isNewFormat ? 'ì‹ í˜•ì‹(ì¶”ì²¨ì¼ í¬í•¨)' : 'êµ¬í˜•ì‹'));
    var start = lines[0].match(/[ê°€-í£a-zA-Z]/) ? 1 : 0;
    for (var i = start; i < lines.length; i++) {
        var line = lines[i].trim();
        if (!line) continue;
        var v = [];
        var tmp = line.replace(/"[^"]*"/g, function(m){ return m.replace(/,/g, 'ï¿½'); });
        tmp.split(',').forEach(function(x){ v.push(x.replace(/ï¿½/g, ',').replace(/^"|"$/g, '').trim()); });
        var minLen = isNewFormat ? 9 : 7;
        if (v.length >= minLen) {
            var round = parseInt(v[0]);
            var nums  = v.slice(numStart, numStart+6).map(Number);
            if (!isNaN(round) && nums.every(function(n){ return !isNaN(n) && n >= 1 && n <= 45; })) {
                var bonus = parseInt(v[bonusIdx]) || 0;
                var obj = { round: round, numbers: nums, bonus: bonus };
                if (dateIdx >= 0 && v[dateIdx]) obj.date = v[dateIdx];
                if (isNewFormat && v[9]) {
                    var wMatch = v[9].match(/\d+/);
                    if (wMatch) obj.winners = wMatch[0] + 'ëª…';
                }
                parsed.push(obj);
            }
        }
    }
    if (!parsed.length) { addLog('ìœ íš¨í•œ ë°ì´í„° ì—†ìŒ', 'error'); return; }

    addLog(parsed.length + 'ê°œ íšŒì°¨ íŒŒì‹± ì™„ë£Œ', 'success');

    // ê¸°ì¡´ ë°ì´í„°ì™€ ë³‘í•© (ì¤‘ë³µ íšŒì°¨ ë®ì–´ì“°ê¸°)
    parsed.forEach(function(d) {
        var idx = lottoData.findIndex(function(x){ return x.round === d.round; });
        if (idx >= 0) { lottoData[idx] = d; }
        else { lottoData.push(d); }
    });
    lottoData.sort(function(a,b){ return a.round - b.round; });

    var importEl = document.getElementById('importSuccess');
    if (importEl) {
        importEl.innerHTML = 'âœ… <strong>' + lottoData.length + '</strong>ê°œ íšŒì°¨ ë³‘í•© ì™„ë£Œ';
        importEl.classList.remove('hidden');
    }

    showFbStatus('â³ Firebaseì— ì—…ë¡œë“œ ì¤‘... (' + lottoData.length + 'íšŒì°¨)', 'info');
    saveHistoryToFirebase().then(function(ok) {
        if (ok) {
            showFbStatus('âœ… Firebase ì—…ë¡œë“œ ì™„ë£Œ (' + lottoData.length + 'íšŒì°¨)', 'ok');
            addLog('Firebase ì—…ë¡œë“œ ì™„ë£Œ', 'success');
            updateNextRoundDisplay();
            updateLatestHeader();
            refreshFbSummary();
        } else {
            showFbStatus('âŒ Firebase ì—…ë¡œë“œ ì‹¤íŒ¨ (ë¡œì»¬ì—ëŠ” ì €ì¥ë¨)', 'err');
        }
    });
}

// â”€â”€ CSV ë‹¤ìš´ë¡œë“œ â”€â”€
function downloadWinCSV() {
    if (!lottoData.length) { alert('ë°ì´í„° ì—†ìŒ'); return; }
    var csv = '\uFEFFíšŒì°¨,ë²ˆí˜¸1,ë²ˆí˜¸2,ë²ˆí˜¸3,ë²ˆí˜¸4,ë²ˆí˜¸5,ë²ˆí˜¸6,ë³´ë„ˆìŠ¤\n';
    lottoData.forEach(function(d){
        csv += d.round + ',' + d.numbers.join(',') + ',' + (d.bonus || 0) + '\n';
    });
    var a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([csv], {type:'text/csv;charset=utf-8;'}));
    a.download = 'ë‹¹ì²¨ë²ˆí˜¸.csv';
    a.click();
}

// â”€â”€ LocalStorage ì €ì¥ ë°ì´í„° ë¡œë“œ ë²„íŠ¼ â”€â”€
function loadFromLS() {
    try {
        var raw = localStorage.getItem(LS_KEY);
        if (!raw) { showFbStatus('ì €ì¥ëœ ë¡œì»¬ ë°ì´í„° ì—†ìŒ', 'info'); return; }
        var obj = JSON.parse(raw);
        if (!obj.data || !obj.data.length) { showFbStatus('ë¡œì»¬ ë°ì´í„° ë¹„ì–´ìˆìŒ', 'info'); return; }
        lottoData = obj.data;
        updateNextRoundDisplay();
        updateLatestHeader();
        showFbStatus('ğŸ“‚ ë¡œì»¬ì—ì„œ ' + lottoData.length + 'íšŒì°¨ ë¡œë“œ ì™„ë£Œ', 'ok');
        addLog('LocalStorageì—ì„œ ' + lottoData.length + 'íšŒì°¨ ë¡œë“œ', 'success');
    } catch(e) { showFbStatus('ë¡œì»¬ ë¡œë“œ ì‹¤íŒ¨: ' + e.message, 'err'); }
}

function clearLS() {
    if (!confirm('ë¡œì»¬ ì €ì¥ ë°ì´í„°ë¥¼ ì‚­ì œí• ê¹Œìš”?\n(Firebase ë°ì´í„°ëŠ” ìœ ì§€ë©ë‹ˆë‹¤)')) return;
    localStorage.removeItem(LS_KEY);
    showFbStatus('ğŸ—‘ï¸ ë¡œì»¬ ìºì‹œ ì‚­ì œë¨', 'info');
}

// â”€â”€ ë‹¤ì´ì–¼ë¡œê·¸ â”€â”€
function openDialog(slot) {
    dialogSlot    = slot;
    dialogMode    = 'normal';
    dialogTempVal = inputNums[slot];
    var used = inputNums.filter(function(n,i){ return n !== null && i !== slot; });
    if (bonusNum) used.push(bonusNum);
    document.getElementById('dialogTitle').textContent = (slot+1) + 'ë²ˆì§¸ ë²ˆí˜¸ ì„ íƒ';
    buildDialogGrid(used);
    document.getElementById('dialogOverlay').classList.remove('hidden');
}

function openBonusDialog() {
    dialogMode    = 'bonus';
    dialogTempVal = bonusNum;
    var used = inputNums.filter(function(n){ return n !== null; });
    document.getElementById('dialogTitle').textContent = 'â­ ë³´ë„ˆìŠ¤ë²ˆí˜¸ ì„ íƒ';
    buildDialogGrid(used);
    document.getElementById('dialogOverlay').classList.remove('hidden');
}

function buildDialogGrid(usedNums) {
    var grid = document.getElementById('dialogGrid');
    grid.innerHTML = '';
    for (var n = 1; n <= 45; n++) {
        (function(num) {
            var d = document.createElement('div');
            d.className = 'd-num' + (dialogTempVal === num ? ' d-sel' : '') + (usedNums.indexOf(num) >= 0 ? ' d-used' : '');
            d.textContent = num;
            d.onclick = function() {
                if (dialogTempVal === num) { dialogTempVal = null; d.classList.remove('d-sel'); }
                else {
                    var prev = grid.querySelector('.d-sel');
                    if (prev) prev.classList.remove('d-sel');
                    dialogTempVal = num; d.classList.add('d-sel');
                }
            };
            grid.appendChild(d);
        })(n);
    }
}

function confirmDialog() {
    if (dialogMode === 'bonus') {
        bonusNum = dialogTempVal;
        var btn = document.getElementById('bonusBtn');
        if (bonusNum !== null) {
            btn.textContent = bonusNum;
            btn.classList.add('filled');
        } else {
            btn.textContent = 'ë³´ë„ˆìŠ¤';
            btn.classList.remove('filled');
        }
    } else {
        if (dialogTempVal !== null) {
            inputNums[dialogSlot] = dialogTempVal;
            refreshNumBtns();
        }
    }
    updatePreview();
    closeDialog();
}

function closeDialog() {
    document.getElementById('dialogOverlay').classList.add('hidden');
    dialogSlot = -1; dialogMode = 'normal'; dialogTempVal = null;
}
function closeDialogOutside(e) {
    if (e.target === document.getElementById('dialogOverlay')) closeDialog();
}

function refreshNumBtns() {
    var btns = document.querySelectorAll('#numInputGrid .num-btn');
    inputNums.forEach(function(val, i) {
        if (!btns[i]) return;
        if (val !== null) { btns[i].textContent = val; btns[i].classList.add('filled'); }
        else { btns[i].textContent = (i+1) + 'ë²ˆ'; btns[i].classList.remove('filled'); }
    });
    // ë³´ë„ˆìŠ¤ ë²„íŠ¼ ì´ˆê¸°í™”
    var bonusBtn = document.getElementById('bonusBtn');
    if (bonusBtn) {
        if (bonusNum !== null) { bonusBtn.textContent = bonusNum; bonusBtn.classList.add('filled'); }
        else { bonusBtn.textContent = 'ë³´ë„ˆìŠ¤'; bonusBtn.classList.remove('filled'); }
    }
}

// â”€â”€ í˜ì´ì§€ ì´ˆê¸°í™” â”€â”€
window.addEventListener('load', async function() {
    showFbStatus('ğŸ”¥ Firebase ì—°ê²° ì¤‘...', 'info');
    try {
        // Firebaseì—ì„œ í˜„ì¬ ë°ì´í„° ë¡œë“œ
        var fbData = await loadFromFirebase();
        if (fbData && fbData.length > 0) {
            lottoData = fbData;
            showFbStatus('âœ… Firebase ì—°ê²° ì™„ë£Œ (' + lottoData.length + 'íšŒì°¨ ë¡œë“œ)', 'ok');
            addLog('Firebaseì—ì„œ ' + lottoData.length + 'íšŒì°¨ ë¡œë“œ ì™„ë£Œ', 'success');
        } else {
            // Firebase ë¹„ì–´ìˆìœ¼ë©´ LocalStorage í™•ì¸
            try {
                var raw = localStorage.getItem(LS_KEY);
                if (raw) {
                    var obj = JSON.parse(raw);
                    if (obj.data && obj.data.length > 0) {
                        lottoData = obj.data;
                        showFbStatus('ğŸ“‚ ë¡œì»¬ ë°ì´í„° ë¡œë“œ (' + lottoData.length + 'íšŒì°¨) â€” FirebaseëŠ” ë¹„ì–´ìˆìŒ', 'info');
                        addLog('LocalStorageì—ì„œ ' + lottoData.length + 'íšŒì°¨ ë¡œë“œ (Firebase ë¹„ì–´ìˆìŒ)', 'success');
                    } else {
                        showFbStatus('âš ï¸ Firebaseì™€ ë¡œì»¬ ëª¨ë‘ ë°ì´í„° ì—†ìŒ. CSVë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”.', 'info');
                    }
                } else {
                    showFbStatus('âš ï¸ ì €ì¥ëœ ë°ì´í„° ì—†ìŒ. CSVë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”.', 'info');
                }
            } catch(e) {
                showFbStatus('âš ï¸ ë°ì´í„° ì—†ìŒ', 'info');
            }
        }
    } catch(e) {
        showFbStatus('âŒ Firebase ì—°ê²° ì‹¤íŒ¨: ' + e.message, 'err');
        addLog('Firebase ì—°ê²° ì‹¤íŒ¨: ' + e.message, 'error');
    }

    updateNextRoundDisplay();
    updateLatestHeader();
    refreshFbSummary();
});
</script>

</body>
</html>
