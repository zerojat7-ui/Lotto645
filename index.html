<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>ë¡œë˜ 6/45</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .loader-box {
      background: white;
      border-radius: 20px;
      padding: 40px 30px;
      text-align: center;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      max-width: 360px;
      width: 90%;
    }
    .loader-icon { font-size: 64px; margin-bottom: 16px; animation: bounce 1s infinite; }
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50%       { transform: translateY(-10px); }
    }
    .loader-title { font-size: 24px; font-weight: bold; color: #333; margin-bottom: 8px; }
    .loader-bar {
      background: #f0f0f0; border-radius: 10px;
      height: 8px; overflow: hidden; margin: 16px 0;
    }
    .loader-fill {
      height: 100%; width: 0%; border-radius: 10px;
      background: linear-gradient(90deg, #667eea, #764ba2);
      transition: width 0.4s ease;
    }
    .loader-status  { font-size: 13px; color: #666; min-height: 20px; }
    .loader-detail  { font-size: 11px; color: #aaa; margin-top: 6px; min-height: 16px; }
    .loader-step    { display: flex; justify-content: center; gap: 8px; margin-top: 14px; flex-wrap: wrap; }
    .step-dot {
      width: 10px; height: 10px; border-radius: 50%;
      background: #e0e0e0; transition: background 0.3s;
    }
    .step-dot.done   { background: #00C49F; }
    .step-dot.active { background: #667eea; animation: pulse 0.8s infinite; }
    @keyframes pulse { 0%,100%{transform:scale(1);} 50%{transform:scale(1.4);} }
    .error-box { margin-top: 14px; display: none; }
    .error-msg { font-size: 12px; color: #dc3545; margin-bottom: 10px; }
    .retry-btn {
      padding: 8px 20px; background: #667eea; color: white;
      border: none; border-radius: 8px; cursor: pointer; font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="loader-box">
    <div class="loader-icon">ğŸ°</div>
    <div class="loader-title">ë¡œë˜ 6/45</div>
    <div class="loader-bar"><div class="loader-fill" id="loaderFill"></div></div>
    <div class="loader-status" id="loaderStatus">ì´ˆê¸°í™” ì¤‘...</div>
    <div class="loader-detail" id="loaderDetail"></div>
    <div class="loader-step">
      <div class="step-dot" id="step1"></div><!-- Firebase ì—°ê²° -->
      <div class="step-dot" id="step2"></div><!-- ë°ì´í„° ë¡œë“œ -->
      <div class="step-dot" id="step3"></div><!-- LS ì €ì¥ -->
      <div class="step-dot" id="step4"></div><!-- ì´ë™ -->
    </div>
    <div class="error-box" id="errorBox">
      <div class="error-msg" id="errorMsg"></div>
      <button class="retry-btn" onclick="location.reload()">ë‹¤ì‹œ ì‹œë„</button>
    </div>
  </div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
<script>
var LS_KEY         = 'lotto645_v2';
var FB_COLLECTION  = 'lotto_history';
var FB_HISTORY_DOC = 'lotto645_history';

function setFill(pct)   { document.getElementById('loaderFill').style.width = pct + '%'; }
function setStatus(msg) { document.getElementById('loaderStatus').textContent = msg; }
function setDetail(msg) { document.getElementById('loaderDetail').textContent = msg; }
function stepActive(n)  { document.getElementById('step'+n).className = 'step-dot active'; }
function stepDone(n)    { document.getElementById('step'+n).className = 'step-dot done'; }
function showError(msg) {
    document.getElementById('errorMsg').textContent = msg;
    document.getElementById('errorBox').style.display = 'block';
}

function goMain() {
    stepDone(4);
    setFill(100);
    setStatus('ì´ë™ ì¤‘...');
    setTimeout(function(){ location.href = 'main.html'; }, 300);
}

function saveToLS(data) {
    try {
        localStorage.setItem(LS_KEY, JSON.stringify({
            savedAt: new Date().toISOString(),
            data   : data
        }));
    } catch(e) {
        console.warn('LS ì €ì¥ ì‹¤íŒ¨:', e.message);
    }
}

function getFromLS() {
    try {
        var raw = localStorage.getItem(LS_KEY);
        if (!raw) return null;
        var obj = JSON.parse(raw);
        return (obj.data && obj.data.length > 0) ? obj : null;
    } catch(e) { return null; }
}

// â”€â”€ ë©”ì¸ ë¡œë“œ ë¡œì§ â”€â”€
window.addEventListener('load', async function() {

    // â”€â”€ STEP 1: Firebase ì´ˆê¸°í™” â”€â”€
    stepActive(1);
    setStatus('Firebase ì—°ê²° ì¤‘...');
    setFill(10);

    var db = null;
    try {
        firebase.initializeApp({
            apiKey:            "AIzaSyB4S8qkK07QYXq5yw0Coo69sZBIk0uew2E",
            authDomain:        "randextraccube-engine.firebaseapp.com",
            projectId:         "randextraccube-engine",
            storageBucket:     "randextraccube-engine.firebasestorage.app",
            messagingSenderId: "515597545439",
            appId:             "1:515597545439:web:f1e804554406719a3cde6a"
        });
        db = firebase.firestore();
        window._lottoDB = db;
        stepDone(1);
        setFill(25);
    } catch(e) {
        stepDone(1); // ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰ (LS í´ë°±)
        setDetail('Firebase ì´ˆê¸°í™” ì‹¤íŒ¨: ' + e.message);
    }

    // â”€â”€ STEP 2: Firebaseì—ì„œ ë°ì´í„° ë¡œë“œ â”€â”€
    stepActive(2);
    setStatus('ë‹¹ì²¨ ë°ì´í„° ë¡œë“œ ì¤‘...');
    setFill(35);

    var lottoData = null;

    if (db) {
        try {
            setDetail('ğŸ”¥ Firebaseì—ì„œ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...');
            var snap = await db.collection(FB_COLLECTION).doc(FB_HISTORY_DOC).get();
            if (snap.exists) {
                var fbObj = snap.data();
                if (fbObj && fbObj.draws && fbObj.draws.length > 0) {
                    lottoData = fbObj.draws;
                    setDetail('ğŸ”¥ Firebase: ' + lottoData.length + 'íšŒì°¨ ë¡œë“œ');
                    setFill(60);
                }
            }
        } catch(e) {
            setDetail('Firebase ë¡œë“œ ì‹¤íŒ¨, ë¡œì»¬ ìºì‹œ í™•ì¸ ì¤‘...');
        }
    }

    // â”€â”€ Firebase ì—†ìœ¼ë©´ LocalStorage ìºì‹œ í™•ì¸ â”€â”€
    if (!lottoData) {
        setDetail('ğŸ’¾ ë¡œì»¬ ìºì‹œ í™•ì¸ ì¤‘...');
        var lsObj = getFromLS();
        if (lsObj) {
            // LS ìºì‹œê°€ ìˆìœ¼ë©´ ì¼ë‹¨ ì‚¬ìš©, Firebaseì™€ íšŒì°¨ ë¹„êµëŠ” ìŠ¤í‚µ (ì´ë¯¸ ì‹¤íŒ¨í–ˆìœ¼ë¯€ë¡œ)
            lottoData = lsObj.data;
            var at = new Date(lsObj.savedAt).toLocaleString('ko-KR');
            setDetail('ğŸ’¾ ë¡œì»¬ ìºì‹œ: ' + lottoData.length + 'íšŒì°¨ (' + at + ')');
            setFill(60);
        }
    }

    // â”€â”€ Firebase ì„±ê³µ + LS ìºì‹œë„ ìˆìœ¼ë©´ ìµœì‹  ë¹„êµ â”€â”€
    if (lottoData && db) {
        var lsObj2 = getFromLS();
        if (lsObj2 && lsObj2.data && lsObj2.data.length > 0) {
            var lsLast = lsObj2.data[lsObj2.data.length-1].round;
            var fbLast = lottoData[lottoData.length-1].round;
            if (fbLast >= lsLast) {
                // Firebaseê°€ ë” ìµœì‹ ì´ê±°ë‚˜ ë™ì¼ â†’ Firebase ì‚¬ìš©
                setDetail('ğŸ”¥ Firebase ìµœì‹  (' + fbLast + 'íšŒì°¨)');
            } else {
                // LSê°€ ë” ìµœì‹  â†’ LS ì‚¬ìš© (ë¹„ì •ìƒ ìƒí™©)
                lottoData = lsObj2.data;
                setDetail('ğŸ’¾ ë¡œì»¬ì´ ë” ìµœì‹  (' + lsLast + 'íšŒì°¨)');
            }
        }
    }

    stepDone(2);
    setFill(70);

    // â”€â”€ history.json í´ë°± (Firebase + LS ëª¨ë‘ ì‹¤íŒ¨) â”€â”€
    if (!lottoData) {
        setStatus('history.json ë¡œë“œ ì¤‘...');
        setDetail('ğŸ“¡ history.json ë‹¤ìš´ë¡œë“œ ì¤‘...');
        try {
            var resp = await fetch('history.json');
            if (resp.ok) {
                var jsonData = await resp.json();
                if (jsonData && jsonData.length > 0) {
                    lottoData = jsonData;
                    setDetail('ğŸ“¡ history.json: ' + lottoData.length + 'íšŒì°¨');
                    setFill(75);
                }
            }
        } catch(e) {
            setDetail('history.json ì—†ìŒ');
        }
    }

    // â”€â”€ ë°ì´í„° ì—†ìœ¼ë©´ main.htmlë¡œ ë³´ë‚´ì„œ ê±°ê¸°ì„œ ì²˜ë¦¬ â”€â”€
    if (!lottoData || lottoData.length === 0) {
        setStatus('ë°ì´í„° ì—†ìŒ');
        setDetail('main.htmlì—ì„œ ë°ì´í„°ë¥¼ ì…ë ¥í•˜ê±°ë‚˜ LoadData.htmlì„ ì´ìš©í•˜ì„¸ìš”');
        stepDone(2); stepDone(3);
        setTimeout(goMain, 1500);
        return;
    }

    // â”€â”€ STEP 3: LocalStorageì— ì €ì¥ â”€â”€
    stepActive(3);
    setStatus('ë°ì´í„° ìºì‹± ì¤‘...');
    setFill(85);
    saveToLS(lottoData);
    setDetail('ğŸ’¾ ' + lottoData.length + 'íšŒì°¨ ë¡œì»¬ ìºì‹œ ì €ì¥ ì™„ë£Œ');
    stepDone(3);
    setFill(95);

    // â”€â”€ STEP 4: main.html ì´ë™ â”€â”€
    stepActive(4);
    setStatus('ì¤€ë¹„ ì™„ë£Œ!');
    setDetail('ì´ ' + lottoData.length + 'íšŒì°¨ ë°ì´í„° ë¡œë“œ ì™„ë£Œ');

    setTimeout(goMain, 500);
});
</script>
</body>
</html>
